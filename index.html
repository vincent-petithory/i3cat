<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640" />

    <link rel="stylesheet" href="stylesheets/core.css" media="screen"/>
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)"/>
    <link rel="stylesheet" href="stylesheets/pygment_trac.css"/>

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>I3cat by vincent-petithory</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/vincent-petithory/i3cat">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>I3cat</h1>
            <h2>A simple program to combine multiple i3bar JSON inputs into one to forward to i3bar.</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/vincent-petithory/i3cat/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/vincent-petithory/i3cat/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <blockquote>
<p>A simple program to combine multiple i3bar JSON inputs into one to forward to i3bar.</p>
</blockquote>

<p><a href="https://app.wercker.com/project/bykey/f9749c41b63024450dc703f139e922ce"><img src="https://app.wercker.com/status/f9749c41b63024450dc703f139e922ce/s/" alt="wercker status" title="wercker status"></a></p>

<h2>
<a name="motivation" class="anchor" href="#motivation"><span class="octicon octicon-link"></span></a>Motivation</h2>

<ul>
<li>enjoy the simplicity of i3status, do not replace it with a fully featured wrapper</li>
<li>use simple shell scripts to add new i3bar blocks</li>
</ul><h2>
<a name="walkthrough" class="anchor" href="#walkthrough"><span class="octicon octicon-link"></span></a>Walkthrough</h2>

<h3>
<a name="install" class="anchor" href="#install"><span class="octicon octicon-link"></span></a>Install</h3>

<p>Several options:</p>

<ul>
<li>Download a binary for your platform <a href="http://gobuild.io/github.com/vincent-petithory/i3cat"><img src="http://gobuild.io/badge/github.com/vincent-petithory/i3cat/download.png" alt="Gobuild Download"></a>
</li>
<li>
<a href="http://golang.org/doc/install">Install Go</a> and run <code>go get github.com/vincent-petithory/i3cat</code>
</li>
<li>If you're on Arch Linux, you can install from <a href="https://aur.archlinux.org/packages/i3cat-git/">AUR</a>.</li>
</ul><h3>
<a name="get-what-you-had-with-i3status" class="anchor" href="#get-what-you-had-with-i3status"><span class="octicon octicon-link"></span></a>Get what you had with i3status:</h3>

<p><code>status_command i3status --config ~/.i3/status</code> becomes <code>status_command echo "i3status --config ~/.i3/status" | i3cat</code></p>

<p>But since you will want to add other blocks, it's more handy to add the commands in a conf file:</p>

<pre><code>$ cat ~/.i3/i3cat.conf
# i3 status
i3status -c ~/.i3/status
</code></pre>

<p>and the status command is now <code>status_command i3cat</code> (<code>~/.i3/i3cat.conf</code> is the default location for its conf file).</p>

<p>Note that your i3status'conf must have his output in i3bar format. If you didn't have it yet, modify it as follows:</p>

<pre><code>general {
    ...
    output_format = i3bar
    ...
}
</code></pre>

<h3>
<a name="add-a-block" class="anchor" href="#add-a-block"><span class="octicon octicon-link"></span></a>Add a block</h3>

<p>Say we want to display the current song played by MPD and its state. The script could be:</p>

<pre><code>$ cat ~/.i3/mpd-nowplaying.sh
#!/bin/sh
display_song() {
    status=
    color=
    case $(mpc status | sed 1d | head -n1 | awk '{ print $1 }') in
    '[playing]')
        status=
        color='#36a8d5'
        ;;
    '[paused]')
        status=
        color=
        ;;
    esac
    echo '[{"name": "mpd", "instance": "now playing", "full_text": " '${status}' '$1'", "color": "'${color}'"}]'
}

(while :; do
    display_song "$(mpc current --wait)"
done) &amp;

while :; do
    display_song "$(mpc current)"
    mpc idle player &gt; /dev/null
done
</code></pre>

<p>Edit <code>~/.i3/i3cat.conf</code>:</p>

<pre><code>$ cat i3cat.conf
# mpc status
~/.i3/mpd-nowplaying.sh
# i3 status
i3status -c ~/.i3/status
</code></pre>

<p>The order matters: the output of the commands are sent to i3bar in that order.
Lines starting with <code>#</code> are comments and ignored.</p>

<p>Note the JSON output of the script is an array. <code>i3cat</code> also supports variants like the output from <code>i3status</code>: a i3bar header (or not) followed by an infinite array.</p>

<h4>
<a name="replace-echo-by-i3cat-encode" class="anchor" href="#replace-echo-by-i3cat-encode"><span class="octicon octicon-link"></span></a>Replace echo by i3cat encode</h4>

<p>Outputting JSON by hand works only for simple cases.
<code>i3cat</code> provides a helper command to send blocks:</p>

<pre><code>echo '[{"name": "mpd", "instance": "now playing", "full_text": " '${status}' '$1'", "color": "'${color}'"}]'
</code></pre>

<p>becomes</p>

<pre><code>i3cat encode --name mpd --instance "now playing" --color "${color}" " ${status} $1"
</code></pre>

<h3>
<a name="listen-for-click-events-on-a-block" class="anchor" href="#listen-for-click-events-on-a-block"><span class="octicon octicon-link"></span></a>Listen for click events on a block</h3>

<p>i3cat listens for click events generated by the user and writes their JSON representation to the STDIN of the command which created the clicked block.</p>

<p>See <a href="http://i3wm.org/docs/i3bar-protocol.html">the i3bar protocol</a> for details on its structure.</p>

<p>Using our MPD script from above, we want that when we click on its block, we want i3 to focus a container marked as <em>music</em> (e.g ncmpcpp).
All that is needed is to read the process' <code>STDIN</code>. Each i3bar click event is output on one line, so a generic recipe boils down to:</p>

<pre><code>cat | while read line; do on_click_event "$line"; done
</code></pre>

<p><code>on_click_event</code> will parse the JSON output and perform the action.</p>

<p>To read properties of an incoming click event, you could use:</p>

<pre><code>#!/bin/sh
click_event_prop() {
    python -c "import json,sys; obj=json.load(sys.stdin); print(obj['$1'])"
}
...
# read the 'button' property
button=$(echo $@ | click_event_prop button)
</code></pre>

<p>But <code>i3cat</code> provides a decode command for that:</p>

<pre><code>button=$(echo $@ | i3cat decode button)
</code></pre>

<p>Full example below:</p>

<pre><code>#!/bin/sh
display_song() {
    status=
    color=
    case $(mpc status | sed 1d | head -n1 | awk '{ print $1 }') in
    '[playing]')
        status=
        color='#36a8d5'
        ;;
    '[paused]')
        status=
        color=
        ;;
    esac
    i3cat encode --name mpd --instance "now playing" --color "${color}" " ${status} $1"
}

on_click_event() {
    button=$(echo $@ | i3cat decode button)
    case $button in
    1)
        i3-msg '[con_mark="music"]' focus &gt; /dev/null
        ;;
    esac
}

(while :; do
    display_song "$(mpc current --wait)"
done) &amp;

(while :; do
    display_song "$(mpc current)"
    mpc idle player &gt; /dev/null
done) &amp;

cat | while read line; do on_click_event "$line"; done
</code></pre>

<h4>
<a name="case-of-programs-which-you-cant-read-stdin-from" class="anchor" href="#case-of-programs-which-you-cant-read-stdin-from"><span class="octicon octicon-link"></span></a>Case of programs which you can't read stdin from</h4>

<p>You simply need to wrap them in a script of your choice.
Example with i3status and a Shell script:</p>

<pre><code>#!/bin/sh
on_click_event() {
    button=$(echo "$@" | i3cat decode button)
    if [ $button != '1' ]; then
        return
    fi
    name=$(echo "$@" | i3cat decode name)
    instance=$(echo "$@" | i3cat decode instance)
    # Do something with block $name::$instance ...
}

# Output i3status blocks
i3status -c $HOME/.i3/status &amp;
# Read stdin for JSON click events
cat | while read line; do on_click_event "$line"; done
</code></pre>

<h3>
<a name="more" class="anchor" href="#more"><span class="octicon octicon-link"></span></a>More</h3>

<p>Run <code>i3cat -h</code> for a list of options:</p>

<pre><code>Usage: i3cat [COMMAND] [ARGS]

  If COMMAND is not specified, i3cat will print i3bar blocks to stdout.

  -cmd-file="$HOME/.i3/i3cat.conf": File listing of the commands to run. It will read from STDIN if - is provided
  -debug-file="": Outputs JSON to this file as well; for debugging what is sent to i3bar.
  -header-clickevents=false: The i3bar header click_events
  -header-contsignal=0: The i3bar header cont_signal. i3cat will send this signal to the processes it manages.
  -header-stopsignal=0: The i3bar header stop_signal. i3cat will send this signal to the processes it manages.
  -header-version=1: The i3bar header version
  -log-file="": Logs i3cat events in this file. Defaults to STDERR

decode: FIELD

  Reads STDIN and decodes a JSON payload representing a click event; typically sent by i3bar.
  It will print the FIELD from the JSON structure to stdout.

  Possible fields are name, instance, button, x, y.


encode: [OPTS] [FULL_TEXT...]

  Concats FULL_TEXT arguments, separated with spaces, and encodes it as an i3bar block JSON payload.
  If FULL_TEXT is -, it will read from STDIN instead.

  The other fields of an i3bar block are optional and specified with the following options:

  -align="": the block.align field to encode.
  -color="": the block.color field to encode.
  -instance="": the block.instance field to encode.
  -min-width=0: the block.min_width field to encode.
  -name="": the block.name field to encode.
  -separator=false: the block.separator field to encode.
  -separator-block-width=0: the block.separator_block_width field to encode.
  -short-text="": the block.short_text field to encode.
  -single=false: If true, the block will not be in a JSON array. This allows to combine other blocks before sending to i3bar.
  -urgent=false: the block.urgent field to encode.
</code></pre>

<h2>
<a name="design" class="anchor" href="#design"><span class="octicon octicon-link"></span></a>Design</h2>

<p><code>i3cat</code> sends data to i3bar only when necessary: when a command sends an updated output of its blocks, <code>i3cat</code> caches it and sends to i3bar the updated output of all blocks, using the latest cached blocks of the other commands. This means commands don't need to have the same update frequency.</p>

<p>It is not advised to send SIGSTOP and SIGCONT signals to<code>i3cat</code>, as its subprocesses will continue to output data anyway.
For pausing and resuming processing (usually asked by i3bar), <code>i3cat</code> will listen for SIGUSR1 and SIGUSR2 for pausing and resuming, respectively. It will then forward the signals specified with <code>-header-stopsignal</code> and <code>-header-contsignal</code> flags (defaults to SIGSTOP and SIGCONT) to all its managed processes.</p>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/vincent-petithory">vincent-petithory</a> can be found on <a href="https://github.com/vincent-petithory/i3cat">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="http://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

    
  </body>
</html>
